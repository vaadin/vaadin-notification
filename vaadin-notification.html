<!--
@license
Copyright (c) 2017 Vaadin Ltd.
This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
-->

<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../vaadin-overlay/vaadin-overlay.html">
<link rel="import" href="../vaadin-development-mode-detector/vaadin-development-mode-detector.html">

<dom-module id="vaadin-notification-overlay-default-theme" theme-for="vaadin-notification-overlay">
  <template>
    <style>
      [part="content"] {
        padding: 4px;
      }

      [part^="top-"],
      [part^="bottom-"],
      [part="middle"] {
        padding: 0 4px;
      }

      [part^="top-"] > *,
      [part^="bottom-"] > *,
      [part="middle"] > * {
        margin: 4px 0;
      }
    </style>
  </template>
</dom-module>

<dom-module id="vaadin-notification-overlay">
  <template>
    <style>
      [part="content"] {
        position: fixed;
        z-index: 1000;
        top: 0;
        left: 0;
        bottom: var(--vaadin-overlay-viewport-bottom, 0);
        right: 0;
        box-sizing: border-box;

        display: flex;
        flex-direction: column;
        pointer-events: none;
      }

      [part$="-stretch"],
      [part="top"] [part],
      [part="bottom"] [part],
      [part="middle"] {
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
      }

      [part="middle"] {
        position: absolute;
        margin: auto;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        justify-content: center;
      }

      [part="top"],
      [part="bottom"] {
        flex: auto;
        display: flex;
        justify-content: flex-end;
      }

      [part="top"] > [part],
      [part="bottom"] > [part] {
        flex: auto;
        flex-shrink: 1;
        flex-basis: 0;
      }

      [part="top-stretch"],
      [part="top"] > [part] {
        flex-direction: column-reverse;
      }

      [part$="-start"] > * {
        align-self: flex-start;
      }

      [part$="-end"] > * {
        align-self: flex-end;
      }

      [part$="-stretch"] > * {
        max-width: 100vw;
      }

      [part="middle"] > *,
      [part$="-center"] > * {
        align-self: center;
      }

      @media (max-width: 420px) {
        [part="top"],
        [part="bottom"] {
          flex-direction: column;
          flex: 0 1 auto;
        }

        [part="top"] > [part],
        [part="bottom"] > [part] {
          flex-basis: auto;
        }

        [part="middle"] {
          position: relative;
          margin: inherit;
          flex: 1;
        }
      }
    </style>

    <div id="backdrop" part="backdrop" hidden></div>

    <div part="overlay" id="overlay">
      <div part="content" id="content">
        <div part="top-stretch"></div>
        <div part="top">
          <div part="top-start"></div>
          <div part="top-center"></div>
          <div part="top-end"></div>
        </div>
        <div part="middle"></div>
        <div part="bottom">
          <div part="bottom-start"></div>
          <div part="bottom-center"></div>
          <div part="bottom-end"></div>
        </div>
        <div part="bottom-stretch"></div>
      </div>
    </div>
  </template>
</dom-module>

<dom-module id="vaadin-notification-card-default-theme" theme-for="vaadin-notification-card">
  <template>
    <style>
      :host {
        padding: 8px;
        width: 100%;
        max-width: 250px;
        background: lightgrey;
        box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.3);
      }

      @keyframes close-notification {
        100% {
          opacity: 0;
        }
      }

      :host([closing]) {
        animation: close-notification 1000ms;
      }

      @media (max-width: 420px) {
        :host {
          max-width: none;
        }
      }
    </style>
  </template>
</dom-module>

<dom-module id="vaadin-notification-card">
  <template>
    <style>
      :host {
        display: block;
        box-sizing: border-box;
        overflow: auto;
        -webkit-overflow-scrolling: touch;
        pointer-events: auto;
      }
    </style>
    <slot></slot>
  </template>
</dom-module>

<dom-module id="vaadin-notification">
  <template>
    <style>
      :host {
        display: none;
      }
    </style>
    <vaadin-notification-card id="vaadin-notification-card">
    </vaadin-notification-card>
  </template>

  <script>
    {
      /**
       * The overlay element.
       *
       * ### Styling
       *
       * See [`<vaadin-overlay>` documentation](https://github.com/vaadin/vaadin-overlay/blob/master/vaadin-overlay.html)
       * for `<vaadin-notification-overlay>` parts.
       *
       * See [ThemableMixin – how to apply styles for shadow parts](https://github.com/vaadin/vaadin-themable-mixin/wiki)
       *
       * @memberof Vaadin
       */
      class VaadinNotificationOverlay extends Vaadin.OverlayElement {
        static get is() {
          return 'vaadin-notification-overlay';
        }

        ready() {
          super.ready();
          this.modeless = true;
        }
      }

      /**
       * The container element for the notification
       *
       * ### Styling
       *
       * [Generic styling/theming documentation](https://cdn.vaadin.com/vaadin-valo-theme/0.3.1/demo/customization.html)
       *
       * @memberof Vaadin
       * @mixes Vaadin.ThemableMixin
       */
      class VaadinNotificationCard extends Vaadin.ThemableMixin(Polymer.Element) {
        static get is() {
          return 'vaadin-notification-card';
        }

        ready() {
          super.ready();
          this.setAttribute('role', 'alert');
          this.setAttribute('aria-live', 'polite');
        }
      }

      /**
       * `<vaadin-notification>` is a Polymer 2 element providing accessible and customizable notifications (toasts).
       *
       * ```
       * <vaadin-notification>
       *   <template>
       *     Your work has been saved
       *   </template>
       * </vaadin-notification>
       * ```
       *
       * ### Styling
       *
       * The following Shadow DOM parts are available for styling:
       *
       * Part name  | Description | Theme for Element
       * -----------|-------------|------------------
       * `content`  | The container of all regions | vaadin-notification-overlay
       * `top-stretch` | top-stretch container | vaadin-notification-overlay
       * `top` | top container | vaadin-notification-overlay
       * `top-start` | top-start container, child of top | vaadin-notification-overlay
       * `top-center` | top-center container, child of top | vaadin-notification-overlay
       * `top-end` | top-end container, child of top | vaadin-notification-overlay
       * `middle` | middle container | vaadin-notification-overlay
       * `bottom` | bottom container | vaadin-notification-overlay
       * `bottom-start` | bottom-start container, child of bottom | vaadin-notification-overlay
       * `bottom-center` | bottom-center container, child of bottom | vaadin-notification-overlay
       * `bottom-end` | bottom-end container, child of bottom | vaadin-notification-overlay
       * `bottom-stretch` | bottom-stretch container, child of bottom | vaadin-notification-overlay
       *
       * See [ThemableMixin – how to apply styles for shadow parts](https://github.com/vaadin/vaadin-themable-mixin/wiki)
       *
       * @memberof Vaadin
       * @demo demo/index.html
       */
      class NotificationElement extends (class extends Polymer.Element {}) {
        static get is() {
          return 'vaadin-notification';
        }

        static get version() {
          return '1.0.0-alpha3';
        }

        static get properties() {
          return {
            /**
             * The duration in milliseconds to show the notification.
             * Set to `0` or a negative number to disable the notification auto-closing.
             */
            duration: {
              type: Number,
              value: 7000
            },

            /**
             * True if the notification is currently displayed.
             */
            opened: {
              type: Boolean,
              value: false,
              notify: true,
              observer: '_openedChanged'
            },

            /**
             * Vertical alignment of the notification in the viewport
             * Valid values are `top-stretch|top|middle|bottom|bottom-stretch`
             */
            verticalAlign: {
              type: String,
              value: 'bottom'
            },

            /**
             * Horizontal alignment of the notification in the viewport
             * Only applies for notifications in `top` or `bottom` containers.
             * Valid values are `start|center|end`
             * Horizontal alignment is skipped in case verticalAlign is set to `top-stretch|middle|bottom-stretch`
             */
            horizontalAlign: {
              type: String,
              value: 'start'
            }
          };
        }

        static get observers() {
          return [
            '_durationChanged(duration, opened)',
            '_orientiationChanged(verticalAlign, horizontalAlign)'
          ];
        }

        /**
         * Opens the notification.
         */
        open() {
          this.opened = true;
        }

        /**
         * Closes the notification.
         */
        close() {
          this.opened = false;
        }

        get _overlay() {
          if (!NotificationElement._overlay) {
            NotificationElement._overlay = document.createElement('vaadin-notification-overlay');
            document.body.appendChild(this._overlay);

            // To reduce DOM queries, we cache all regions eligible for appending notifications
            NotificationElement._overlay.regions = {};
            Array.from(this._overlay.$.content.querySelectorAll('[part]'))
              .forEach(e => e.children.length == 0 && (this._overlay.regions[e.getAttribute('part')] = e));
          }
          return NotificationElement._overlay;
        }

        _openedChanged(opened) {
          if (opened) {
            this._overlay.opened = true;
            if (!this._instance) {
              const template = this.querySelector('template');
              const Templatizer = Polymer.Templatize.templatize(template, this, {
                instanceProps: {
                  detail: true,
                  target: true
                }
              });
              this._instance = new Templatizer({});
              this._card = this.$['vaadin-notification-card'];
              this._card.appendChild(this._instance.root);
              this._card.setAttribute('aria-label', this._card.textContent.trim());
            }

            this._appendNotificationCard();
          } else if (this._card) {
            this._closeNotificationCard();
          }
        }

        _appendNotificationCard() {
          const region = /^(top|bottom)$/.test(this.verticalAlign)
            ? this.verticalAlign + '-' + this.horizontalAlign : this.verticalAlign;

          if (this._overlay.regions[region]) {
            this._overlay.regions[region].appendChild(this._card);
          } else {
            window.console.warn(
              `Invalid alignment parameters provided: vertical-align=${this.verticalAlign} horizontal-align=${this.horizontalAlign}`);
          }
        }

        _removeNotificationCard() {
          this._card.parentNode && this._card.parentNode.removeChild(this._card);
          this._card.removeAttribute('closing');
          this._overlay.opened =
            Object.keys(this._overlay.regions).reduce((prev, part) => this._overlay.regions[part].hasChildNodes() || prev, false);
        }

        _closeNotificationCard() {
          this._durationTimeoutId && clearTimeout(this._durationTimeoutId);
          this._card.setAttribute('closing', '');
          const name = getComputedStyle(this._card).getPropertyValue('animation-name');
          if (name && name != 'none') {
            const listener = () => {
              this._removeNotificationCard();
              this._card.removeEventListener('animationend', listener);
            };
            this._card.addEventListener('animationend', listener);
          } else {
            this._removeNotificationCard();
          }
        }

        _orientiationChanged(vertical, horizontal) {
          if (this.opened) {
            this._appendNotificationCard();
          }
        }

        _durationChanged(duration, opened) {
          if (opened) {
            clearTimeout(this._durationTimeoutId);
            if (duration > 0) {
              this._durationTimeoutId = setTimeout(() => this.close(), duration);
            }
          }
        }
      }

      customElements.define(VaadinNotificationOverlay.is, VaadinNotificationOverlay);
      customElements.define(VaadinNotificationCard.is, VaadinNotificationCard);
      customElements.define(NotificationElement.is, NotificationElement);

      /**
       * @namespace Vaadin
       */
      window.Vaadin = window.Vaadin || {};
      Vaadin.NotificationElement = NotificationElement;
      if (Vaadin.runIfDevelopmentMode) {
        Vaadin.runIfDevelopmentMode('vaadin-usage-statistics');
      }
    }
  </script>
</dom-module>
